<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAIIK - Zeit im Griff – Erfolg im Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a4d4d;
            --secondary: #2d7a7a;
            --accent: #4db8a8;
            --light: #7dd3c0;
            --bg: #f5f8f8;
            --white: #ffffff;
            --text: #1a1a1a;
            --text-light: #666;
            --border: #e0e0e0;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            padding: 20px;
        }

        .login-box {
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 50px;
            width: 100%;
            max-width: 450px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-container {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: bold;
            color: var(--white);
            box-shadow: 0 10px 30px rgba(29, 77, 77, 0.3);
            object-fit: cover;
        }

        .logo-text {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .logo-subtitle {
            font-size: 14px;
            color: var(--text-light);
            font-style: italic;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 500;
        }

        input,
        select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(77, 184, 168, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(29, 77, 77, 0.3);
        }

        .form-options {
            text-align: left;
            margin-bottom: 20px;
        }

        .forgot-link {
            font-size: 14px;
            color: var(--secondary);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .forgot-link:hover {
            text-decoration: underline;
            color: var(--primary);
        }

        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard.active {
            display: flex;
        }

        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white);
            padding: 30px;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-logo {
            width: 180px;
            margin-bottom: 10px;
            object-fit: contain;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .user-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-role {
            font-size: 14px;
            opacity: 0.8;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .stats-label {
            font-size: 13px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .stats-value {
            font-size: 28px;
            font-weight: bold;
        }

        .stats-subtext {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            background: var(--white);
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary);
            font-size: 28px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: var(--white);
        }

        .calendar-container {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .calendar-header h2 {
            color: var(--primary);
            font-size: 24px;
        }

        .calendar-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--accent);
            color: var(--white);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--secondary);
            transform: scale(1.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .month-card {
            background: linear-gradient(135deg, var(--bg), var(--white));
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .month-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--accent);
        }

        .month-name {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .month-stats {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.8;
        }

        .month-stats div {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--border);
        }

        .month-stats div:last-child {
            border-bottom: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-content.modal-lg {
            max-width: 1200px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h2 {
            color: var(--primary);
            font-size: 24px;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--danger);
            color: var(--white);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            transform: rotate(90deg);
            background: #d32f2f;
        }

        .requests-section {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
        }

        .request-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
            transition: all 0.3s ease;
        }

        .request-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .request-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .request-status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .request-details {
            color: var(--text-light);
            font-size: 14px;
            line-height: 1.8;
        }

        .request-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-approve {
            background: var(--success);
            color: var(--white);
        }

        .btn-reject {
            background: var(--danger);
            color: var(--white);
        }

        .btn-small:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(77, 184, 168, 0.1);
        }

        .logout-btn {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 30px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .change-password-btn {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.1);
            /* Etwas heller */
            color: var(--white);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
            /* Kleinerer Abstand als Logout */
        }

        .change-password-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        #notificationBtn {
            position: relative;
            display: none;
        }

        #notificationCount {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: var(--white);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0);
            transition: all 0.3s ease;
        }

        #notificationCount.visible {
            transform: scale(1);
        }

        .notification-card {
            padding: 15px;
            background: var(--bg);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary);
        }

        .notification-card.unread {
            background: var(--white);
            border-left-color: var(--accent);
            font-weight: 600;
        }

        .notification-timestamp {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--text);
        }

        .detail-calendar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .detail-month {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
        }

        .detail-month-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .detail-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .detail-day-header {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-align: center;
            margin-bottom: 5px;
        }

        .detail-day {
            width: 100%;
            aspect-ratio: 1 / 1;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: #e9ecef;
            color: var(--text-light);
        }

        .detail-day.empty {
            background: transparent;
        }

        .detail-day.weekend {
            background: #dee2e6;
        }

        .detail-day.work {
            background: var(--success);
            color: var(--white);
            font-weight: bold;
        }

        .detail-day.vacation {
            background: var(--accent);
            color: var(--white);
            font-weight: bold;
        }

        .detail-day.sick {
            background: var(--danger);
            color: var(--white);
            font-weight: bold;
        }

        .user-manage-table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-manage-table th,
        .user-manage-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        .user-manage-table th {
            background: var(--bg);
        }

        .request-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .request-history-table th,
        .request-history-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            font-size: 14px;
        }

        .request-history-table th {
            background: var(--bg);
        }

        .request-history-table .btn-reject {
            padding: 6px 12px;
            font-size: 12px;
        }

        .action-cell {
            display: flex;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .dashboard.active {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .calendar-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-wrap: wrap;
                gap: 8px;
            }

            .btn-secondary {
                padding: 8px 12px;
                font-size: 14px;
            }

            .modal-content.modal-lg {
                max-width: 100%;
                padding: 20px;
            }

            .detail-calendar {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .login-box {
                padding: 30px;
            }

            .modal-content {
                padding: 20px;
            }

            .modal-content.modal-lg {
                padding: 15px;
            }

            .main-content {
                padding: 15px;
            }

            .sidebar {
                padding: 20px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .modal-header h2 {
                font-size: 20px;
            }

            .logo-text {
                font-size: 30px;
            }

            .stats-value {
                font-size: 24px;
            }

            .stats-card {
                padding: 15px;
            }

            .sidebar-logo {
                width: 150px;
            }

            .month-name {
                font-size: 18px;
            }

            .action-cell {
                flex-direction: column;
            }

            .btn-small {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="logo-container">
                <img src="logo.png" alt="TAIIK Logo" class="logo">
                <div class="logo-text">TAIIK</div>
                <div class="logo-subtitle">Zeit im Griff – Erfolg im Flow</div>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">E-Mail</label>
                    <input type="email" id="email" required placeholder="ihre.email@taiik.de">
                </div>
                <div class="form-group">
                    <label for="password">Passwort</label>
                    <input type="password" id="password" required placeholder="••••••••">
                </div>
                <div class="form-options">
                    <a href="#" id="forgotPasswordLink" class="forgot-link">Passwort vergessen?</a>
                </div>
                <button type="submit" class="btn">Anmelden</button>
            </form>
        </div>
    </div>

    <div id="dashboard" class="dashboard">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="TAIIK Logo" class="sidebar-logo">
                <div class="logo-subtitle">Zeit im Griff</div>
            </div>
            <div class="user-info">
                <div class="user-name" id="userName">Max Mustermann</div>
                <div class="user-role" id="userRole">Mitarbeiter</div>
            </div>
            <div id="statsContainer">
                <div class="stats-card">
                    <div class="stats-label">Arbeitsstunden (2025)</div>
                    <div class="stats-value" id="totalHours">1.847</div>
                    <div class="stats-subtext">von 2.080 geplanten Stunden</div>
                </div>
                <div class="stats-card">
                    <div class="stats-label">Urlaubstage</div>
                    <div class="stats-value" id="vacationDays">12 / 30</div>
                    <div class="stats-subtext">18 Tage verfügbar</div>
                </div>
                <div class="stats-card">
                    <div class="stats-label">Krankheitstage</div>
                    <div class="stats-value" id="sickDays">3</div>
                    <div class="stats-subtext">Jahr 2025</div>
                </div>
                <div class="stats-card">
                    <div class="stats-label">Überstunden</div>
                    <div class="stats-value" id="overtime">+23,5h</div>
                    <div class="stats-subtext">Aktueller Saldo</div>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">Abmelden</button>
            <button class="change-password-btn" onclick="openModal('changePasswordModal')">Passwort ändern</button>

        </div>

        <div class="main-content">
            <div class="header">
                <h1 id="dashboardTitle">Mein Dashboard</h1>
                <div class="header-actions">
                    <button id="notificationBtn" class="btn-secondary" onclick="openModal('notificationModal')">
                        Meldungen
                        <span id="notificationCount">0</span>
                    </button>
                    <button id="manageUsersBtn" class="btn-secondary" onclick="openModal('userManagementModal')"
                        style="display: none;">
                        Mitarbeiter verwalten
                    </button>
                    <button id="toggleViewBtn" class="btn-secondary"
                        onclick="openModal('detailCalendarModal')">Detail-Ansicht</button>
                    <button class="btn-secondary" onclick="openModal('timeModal')">Arbeitszeit eintragen</button>
                    <button class="btn-secondary" onclick="openModal('vacationModal')">Urlaub beantragen</button>
                    <button class="btn-secondary" onclick="openModal('sickModal')">Krankmeldung</button>
                </div>
            </div>
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2>Jahreskalender 2025</h2>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="changeYear(-1)">◄</button>
                        <span id="currentYear"
                            style="font-size: 20px; font-weight: 600; color: var(--primary);">2025</span>
                        <button class="nav-btn" onclick="changeYear(1)">►</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
            <div id="requestsSection" class="requests-section" style="display: none;">
                <h2 style="color: var(--primary); margin-bottom: 20px;">Ausstehende Anträge</h2>
                <div id="requestsList"></div>
            </div>
        </div>
    </div>

    <div id="timeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Arbeitszeit eintragen</h2>
                <button class="close-btn" onclick="closeModal('timeModal')">×</button>
            </div>
            <form onsubmit="submitTimeEntry(event)">
                <div class="form-group">
                    <label>Datum</label>
                    <input type="date" id="timeDate" required>
                </div>
                <div class="form-group">
                    <label>Startzeit</label>
                    <input type="time" id="startTime" required>
                </div>
                <div class="form-group">
                    <label>Endzeit</label>
                    <input type="time" id="endTime" required>
                </div>
                <div class="form-group">
                    <label>Pause (Minuten)</label>
                    <input type="number" id="breakTime" value="30" min="0" required>
                </div>
                <div class="form-group">
                    <label>Notizen (optional)</label>
                    <textarea id="timeNotes" placeholder="z.B. Projektarbeit, Meeting..."></textarea>
                </div>
                <button type="submit" class="btn">Eintragen</button>
            </form>
        </div>
    </div>

    <div id="vacationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Urlaub beantragen</h2>
                <button class="close-btn" onclick="closeModal('vacationModal')">×</button>
            </div>
            <form onsubmit="submitVacation(event)">
                <div class="form-group">
                    <label>Von Datum</label>
                    <input type="date" id="vacationStart" required>
                </div>
                <div class="form-group">
                    <label>Bis Datum</label>
                    <input type="date" id="vacationEnd" required>
                </div>
                <div class="form-group">
                    <label>Grund (optional)</label>
                    <textarea id="vacationReason" placeholder="z.B. Familienurlaub..."></textarea>
                </div>
                <button type="submit" class="btn">Beantragen</button>
            </form>
        </div>
    </div>

    <div id="sickModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Krankmeldung</h2>
                <button class="close-btn" onclick="closeModal('sickModal')">×</button>
            </div>
            <form onsubmit="submitSickLeave(event)">
                <div class="form-group">
                    <label>Von Datum</label>
                    <input type="date" id="sickStart" required>
                </div>
                <div class="form-group">
                    <label>Voraussichtlich bis</label>
                    <input type="date" id="sickEnd" required>
                </div>
                <div class="form-group">
                    <label>Ärztliches Attest vorhanden?</label>
                    <select id="sickCertificate">
                        <option value="ja">Ja</option>
                        <option value="nein">Nein</option>
                        <option value="folgt">Folgt</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notizen (optional)</label>
                    <textarea id="sickNotes" placeholder="Zusätzliche Informationen..."></textarea>
                </div>
                <button type="submit" class="btn">Melden</button>
            </form>
        </div>
    </div>

    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Meldungen</h2>
                <button class="close-btn" onclick="closeModal('notificationModal')">×</button>
            </div>
            <div id="notificationList">
            </div>
        </div>
    </div>

    <div id="detailCalendarModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 id="detailCalendarTitle">Jahresübersicht 2025</h2>
                <button class="close-btn" onclick="closeModal('detailCalendarModal')">×</button>
            </div>
            <div id="detailCalendarContainer">
            </div>
        </div>
    </div>

    <div id="userManagementModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>Mitarbeiter verwalten</h2>
                <button class="close-btn" onclick="closeModal('userManagementModal')">×</button>
            </div>
            <button class="btn" onclick="openAddUserModal()"
                style="margin-bottom: 20px; width: auto; background: var(--success);">
                + Neuen Mitarbeiter anlegen
            </button>
            <div id="userManagementList">
            </div>
        </div>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 id="editUserTitle">Mitarbeiter bearbeiten</h2>
                <button class="close-btn" onclick="closeModal('editUserModal')">×</button>
            </div>

            <form id="editUserForm" onsubmit="submitUserEdit(event)">
                <input type="hidden" id="editUserEmail">

                <div class="form-group">
                    <label>Abteilung</label>
                    <input type="text" id="editUserAbteilung" class="form-control" placeholder="z.B. Marketing, IT...">
                </div>
                <div class="form-group">
                    <label>Rolle</label>
                    <select id="editUserRole" class="form-control"
                        onchange="toggleManagerSelect(this.value, 'editUserManager', 'managerSelectGroup')">
                        <option value="mitarbeiter">Mitarbeiter</option>
                        <option value="vorgesetzter">Vorgesetzter</option>
                        <option value="hr">HR</option>
                        <option value="ceo">CEO</option>
                    </select>
                </div>
                <div class="form-group" id="managerSelectGroup">
                    <label>Zuständiger Vorgesetzter</label>
                    <select id="editUserManager" class="form-control">
                        <option value="">-- Keiner zugewiesen --</option>
                    </select>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border); margin: 30px 0;">

                <div class="form-group">
                    <label>Arbeitsstunden (Gesamt)</label>
                    <input type="number" step="0.1" id="editTotalHours" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Urlaubstage (Anspruch)</label>
                    <input type="number" id="editVacationTotal" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Urlaubstage (Genommen)</label>
                    <input type="number" id="editVacationTaken" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Krankheitstage</label>
                    <input type="number" id="editSickDays" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Überstunden (Saldo)</label>
                    <input type="number" step="0.1" id="editOvertime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Wöchentliche Soll-Stunden</label>
                    <input type="number" step="0.5" id="editWeeklyHours" class="form-control" required>
                </div>

                <button type="submit" class="btn">Daten speichern</button>
            </form>

            <div style="margin-top: 40px; border-top: 2px solid var(--border); padding-top: 30px;">
                <h3 style="color: var(--primary); margin-bottom: 20px;">Genehmigte Anträge (Logbuch)</h3>
                <div id="editUserRequestsList" style="max-height: 300px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>Neuen Mitarbeiter anlegen</h2>
                <button class="close-btn" onclick="closeModal('addUserModal')">×</button>
            </div>

            <form id="addUserForm" onsubmit="submitAddUser(event)">
                <div class="form-group">
                    <label>Voller Name</label>
                    <input type="text" id="addUserName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>E-Mail</label>
                    <input type="email" id="addUserEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Anfangs-Passwort</label>
                    <input type="password" id="addUserPassword" class="form-control" required
                        placeholder="Mind. 6 Zeichen">

                </div>
                <div class="form-group">
                    <label>Abteilung</label>
                    <input type="text" id="addUserAbteilung" class="form-control" placeholder="z.B. Marketing, IT...">
                </div>
                <div class="form-group">
                    <label>Rolle</label>
                    <select id="addUserRole" class="form-control"
                        onchange="toggleManagerSelect(this.value, 'addUserManager', 'addUserManagerGroup')">
                        <option value="mitarbeiter">Mitarbeiter</option>
                        <option value="vorgesetzter">Vorgesetzter</option>
                        <option value="hr">HR</option>
                        <option value="ceo">CEO</option>
                    </select>
                </div>
                <div class="form-group" id="addUserManagerGroup">
                    <label>Zuständiger Vorgesetzter</label>
                    <select id="addUserManager" class="form-control">
                        <option value="">-- Keiner zugewiesen --</option>
                    </select>
                </div>


                <hr style="border: none; border-top: 1px solid var(--border); margin: 30px 0;">

                <div class="form-group">
                    <label>Wöchentliche Soll-Stunden</label>
                    <input type="number" step="0.5" id="addWeeklyHours" class="form-control" required value="40">
                </div>
                <div class="form-group">
                    <label>Urlaubstage (Anspruch)</label>
                    <input type="number" id="addVacationTotal" class="form-control" required value="30">
                </div>

                <button type="submit" class="btn">Mitarbeiter erstellen</button>

            </form>

        </div>

    </div>

    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Passwort vergessen</h2>
                <button class="close-btn" onclick="closeModal('forgotPasswordModal')">×</button>
            </div>
            <form onsubmit="submitForgotPassword(event)">
                <div class="form-group">
                    <label>Ihre E-Mail</label>
                    <input type="email" id="forgotEmail" required placeholder="Geben Sie Ihre E-Mail ein">
                </div>
                <button type="submit" class="btn">Link anfordern</button>
            </form>
        </div>
    </div>

    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Neues Passwort festlegen</h2>
                <button class="close-btn" onclick="closeModal('changePasswordModal')">×</button>
            </div>
            <form onsubmit="submitChangePassword(event)">
                <div class="form-group">
                    <label>Neues Passwort</label>
                    <input type="password" id="newPassword" required minlength="6" placeholder="Mind. 6 Zeichen">
                </div>
                <div class="form-group">
                    <label>Neues Passwort bestätigen</label>
                    <input type="password" id="confirmPassword" required minlength="6"
                        placeholder="Passwort wiederholen">
                </div>
                <button type="submit" class="btn">Passwort ändern</button>
            </form>
        </div>
    </div>


    <script>
        // --- Supabase Client ---
        const SUPABASE_URL = 'https://mqrkwlhclmpfusnbnbeg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xcmt3bGhjbG1wZnVzbmJuYmVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3ODk4MjAsImV4cCI6MjA3NzM2NTgyMH0.d0aZdt_s-6Xu7MSnhCQXjHKEXfN3hAh5UfmUGjg_zSY';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Lokaler Cache ---
        const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni',
            'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
        let currentYear = 2025;
        let currentUser = null;
        let currentUserStats = null;
        let allRequests = [];
        let allNotifications = [];
        let allUsers = [];

        // --- Datums-Helfer ---
        function parseLocalDate(dateString) {
            const parts = dateString.split('-');
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }
        function isWeekend(dateString) {
            const date = parseLocalDate(dateString);
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6;
        }
        function calculateWorkdays(start, end) {
            const startDate = parseLocalDate(start);
            const endDate = parseLocalDate(end);
            let days = 0;
            if (endDate < startDate) return -1;
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    days++;
                }
            }
            return days;
        }
        function getLocalISODate() {
            const date = new Date();
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().split('T')[0];
        }
        function toLocalISOString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }


        // --- Login / Logout ---
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const loginButton = e.target.querySelector('.btn');
            loginButton.textContent = 'Lade...';
            loginButton.disabled = true;

            const email = document.getElementById('email').value.toLowerCase();
            const password = document.getElementById('password').value;

            try {
                const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });
                if (authError) throw authError;

                let { data: userStats, error: userError } = await supabaseClient
                    .from('Users')
                    .select('*')
                    .eq('email', email)
                    .single();
                if (userError || !userStats) {
                    alert("Login erfolgreich, aber Profil nicht gefunden. Bitte Admin kontaktieren.");
                    await supabaseClient.auth.signOut();
                    throw userError || new Error("Profil-Daten nicht gefunden.");
                }

                currentUser = { email: userStats.email, role: userStats.role, name: userStats.name };
                currentUserStats = userStats;

                await loadAllDataFromSupabase();

                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userRole').textContent = getRoleDisplay(userStats.role);

                updateDashboardStats();
                generateCalendar();

                const manageUsersBtn = document.getElementById('manageUsersBtn');
                const requestsSection = document.getElementById('requestsSection');

                if (userStats.role === 'hr') {
                    requestsSection.style.display = 'block';
                    document.getElementById('dashboardTitle').textContent = 'Management Dashboard';
                    manageUsersBtn.style.display = 'inline-block';
                    loadRequests();
                } else if (userStats.role === 'vorgesetzter' || userStats.role === 'ceo') {
                    requestsSection.style.display = 'block';
                    document.getElementById('dashboardTitle').textContent = 'Management Dashboard';
                    manageUsersBtn.style.display = 'none';
                    loadRequests();
                } else {
                    requestsSection.style.display = 'none';
                    document.getElementById('dashboardTitle').textContent = 'Mein Dashboard';
                    manageUsersBtn.style.display = 'none';
                }

                document.getElementById('notificationBtn').style.display = 'inline-block';
                updateNotificationButton();

            } catch (error) {
                console.error('Login-Fehler:', error);
                alert(`Fehler beim Login: ${error.message}`);
            } finally {
                loginButton.textContent = 'Anmelden';
                loginButton.disabled = false;
            }
        });

        async function loadAllDataFromSupabase() {
            console.log('Lade alle Daten von Supabase...');
            try {
                let { data: requests, error: reqError } = await supabaseClient.from('Requests').select('*');
                if (reqError) throw reqError;
                allRequests = requests;

                let { data: notifications, error: notifError } = await supabaseClient
                    .from('Notifications')
                    .select('*')
                    .or(`targetEmail.eq.${currentUser.email},targetRole.eq.${currentUser.role}`);
                if (notifError) throw notifError;
                allNotifications = notifications;

                if (currentUser.role === 'hr') {
                    let { data: users, error: userError } = await supabaseClient.from('Users').select('*');
                    if (userError) throw userError;
                    allUsers = users;
                    console.log('Mitarbeiterliste geladen:', allUsers);
                } else {
                    allUsers = [];
                }

            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                alert('Konnte Daten nicht vom Server laden.');
            }
        }

        async function logout() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                console.error('Fehler beim Logout:', error);
            }

            currentUser = null;
            currentUserStats = null;
            allRequests = [];
            allNotifications = [];
            allUsers = [];

            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginForm').reset();
            document.getElementById('requestsList').innerHTML = '';
            document.getElementById('notificationBtn').style.display = 'none';
            document.getElementById('manageUsersBtn').style.display = 'none';
        }

        // --- Dashboard UI-Funktionen ---
        function getRoleDisplay(role) {
            switch (role) {
                case 'mitarbeiter': return 'Mitarbeiter';
                case 'vorgesetzter': return 'Vorgesetzter/Teamleiter';
                case 'hr': return 'HR/Management';
                case 'ceo': return 'CEO';
                default: return role;
            }
        }

        function updateDashboardStats() {
            if (!currentUserStats) return;
            const stats = currentUserStats;
            const vacationRemaining = stats.vacationTotal - stats.vacationTaken;
            document.getElementById('totalHours').textContent = stats.totalHours.toFixed(1);
            document.getElementById('vacationDays').textContent = `${stats.vacationTaken} / ${stats.vacationTotal}`;
            document.getElementById('sickDays').textContent = stats.sickDays;
            document.getElementById('overtime').textContent = `${stats.overtime >= 0 ? '+' : ''}${stats.overtime.toFixed(1)}h`;
            document.querySelector('#totalHours + .stats-subtext').textContent = `von ${stats.plannedHours} geplanten Stunden`;
            document.querySelector('#vacationDays + .stats-subtext').textContent = `${vacationRemaining} Tage verfügbar`;
            document.querySelector('#sickDays + .stats-subtext').textContent = `Jahr ${currentYear}`;
            document.querySelector('#overtime + .stats-subtext').textContent = `Aktueller Saldo`;
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            document.getElementById('currentYear').textContent = currentYear;
            const userRequests = allRequests.filter(r =>
                r.employeeEmail === currentUser.email &&
                r.status === 'approved' &&
                (parseLocalDate(r.date).getFullYear() === currentYear || (r.endDate && parseLocalDate(r.endDate).getFullYear() === currentYear))
            );
            for (let i = 0; i < 12; i++) {
                let monthHours = 0, monthVacation = 0, monthSick = 0;
                const daysInMonth = new Date(currentYear, i + 1, 0).getDate();
                userRequests
                    .filter(r => r.type === 'time' && parseLocalDate(r.date).getMonth() === i)
                    .forEach(req => monthHours += req.hours);
                const absenceRequests = userRequests.filter(r => (r.type === 'vacation' || r.type === 'sick') && r.endDate);
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(currentYear, i, day);
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                    for (const req of absenceRequests) {
                        const startDate = parseLocalDate(req.date);
                        const endDate = parseLocalDate(req.endDate);
                        if (currentDate >= startDate && currentDate <= endDate) {
                            if (req.type === 'vacation') monthVacation++;
                            else if (req.type === 'sick') monthSick++;
                            break;
                        }
                    }
                }
                const card = document.createElement('div');
                card.className = 'month-card';
                card.innerHTML = `
                    <div class="month-name">${monthNames[i]}</div>
                    <div class="month-stats">
                        <div><span>Arbeitsstunden:</span><span>${monthHours.toFixed(1)}h</span></div>
                        <div><span>Urlaubstage:</span><span>${monthVacation}</span></div>
                        <div><span>Krankheitstage:</span><span>${monthSick}</span></div>
                    </div>`;
                grid.appendChild(card);
            }
        }

        function changeYear(delta) {
            currentYear += delta;
            generateCalendar();
            updateDashboardStats();
        }

        // --- Modal-Steuerung ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');

            const today = getLocalISODate();

            if (modalId === 'timeModal') { document.getElementById('timeDate').value = today; }
            else if (modalId === 'vacationModal') {
                document.getElementById('vacationStart').value = today;
                document.getElementById('vacationEnd').value = today;
            } else if (modalId === 'sickModal') {
                document.getElementById('sickStart').value = today;
                document.getElementById('sickEnd').value = today;
            } else if (modalId === 'notificationModal') { loadNotifications(); }
            else if (modalId === 'detailCalendarModal') { generateDetailCalendar(); }
            else if (modalId === 'userManagementModal') {
                loadUserManagementList();
            }
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function autoApproveStats(request) {
            console.log("Auto-approving request...", request.id);
            let statsToUpdate = {
                totalHours: currentUserStats.totalHours,
                overtime: currentUserStats.overtime,
                vacationTaken: currentUserStats.vacationTaken,
                sickDays: currentUserStats.sickDays
            };
            let needsUpdate = false;

            if (request.type === 'time') {
                statsToUpdate.totalHours += request.hours;
                statsToUpdate.overtime += (request.hours - (currentUserStats.plannedHours / 260));
                needsUpdate = true;
            } else if (request.type === 'vacation') {
                statsToUpdate.vacationTaken += request.days;
                needsUpdate = true;
            } else if (request.type === 'sick') {
                statsToUpdate.sickDays += request.days;
                needsUpdate = true;
            }

            if (needsUpdate) {
                const { data: updatedUser, error } = await supabaseClient
                    .from('Users')
                    .update(statsToUpdate)
                    .eq('email', currentUser.email)
                    .select()
                    .single();

                if (error) {
                    console.error("Fehler beim Auto-Approve der Stats:", error);
                } else {
                    currentUserStats = updatedUser;
                    updateDashboardStats();
                    generateCalendar();
                }
            }
        }


        async function sendSubmissionNotification(target, message) {
            if (target.role) {
                await createNotificationForRole(target.role, message);
            } else if (target.email) {
                await createNotification(target.email, message);
            }
        }


        // --- Antrags-Submit-Funktionen (ALLE GEÄNDERT FÜR NEUEN WORKFLOW) ---
        async function submitTimeEntry(e) {
            e.preventDefault();
            const date = document.getElementById('timeDate').value;
            if (isWeekend(date)) {
                alert("Geht nicht wegen Sa und So. Arbeitszeit kann nur an Wochentagen eingetragen werden.");
                return;
            }
            const start = document.getElementById('startTime').value, end = document.getElementById('endTime').value;
            const breakMin = parseInt(document.getElementById('breakTime').value, 10);
            const notes = document.getElementById('timeNotes').value;
            const startTime = new Date(`${date}T${start}`), endTime = new Date(`${date}T${end}`);
            let hours = (endTime - startTime) / (1000 * 60 * 60) - (breakMin / 60);
            if (hours <= 0) {
                alert("Endzeit muss nach Startzeit liegen."); return;
            }

            // --- NEUER WORKFLOW ---
            let newStatus = 'pending_manager';
            let showAlert = 'Arbeitszeit erfolgreich eingetragen! Wartet auf Bestätigung.';
            let sendNotification = true;
            let approverEmail = null;
            let approverRole = null;
            let notificationTarget = {};

            if (currentUser.role === 'ceo') {
                newStatus = 'approved';
                showAlert = 'Arbeitszeit als CEO direkt verbucht.';
                sendNotification = false;
            } else if (currentUser.role === 'hr') {
                newStatus = 'pending_ceo';
                approverRole = 'ceo';
                notificationTarget = { role: 'ceo' };
                showAlert = 'Arbeitszeit eingereicht. Wartet auf CEO-Genehmigung.';
            } else if (currentUser.role === 'vorgesetzter') {
                newStatus = 'pending_hr';
                approverRole = 'hr';
                notificationTarget = { role: 'hr' };
                showAlert = 'Arbeitszeit eingereicht. Wartet auf HR-Genehmigung.';
            } else { // mitarbeiter
                if (!currentUserStats.manager_email) {
                    alert("Fehler: Ihnen ist kein Vorgesetzter zugewiesen. Bitte kontaktieren Sie HR.");
                    return;
                }
                newStatus = 'pending_manager';
                approverEmail = currentUserStats.manager_email;
                notificationTarget = { email: approverEmail };
                showAlert = 'Arbeitszeit eingereicht. Wartet auf Genehmigung durch Vorgesetzten.';
            }
            // --- Ende Workflow ---

            const newRequest = {
                type: 'time',
                employeeEmail: currentUser.email,
                employeeName: currentUser.name,
                date: date,
                endDate: date,
                details: `${start} - ${end} (${breakMin}min Pause) = ${hours.toFixed(2)}h`,
                hours: hours,
                notes: notes,
                status: newStatus,
                approver_email: approverEmail,
                approver_role: approverRole
            };
            try {
                const { data, error } = await supabaseClient.from('Requests').insert(newRequest).select().single();
                if (error) throw error;
                allRequests.push(data);

                if (newStatus === 'approved') { // Nur für CEO
                    await autoApproveStats(data);
                }

                if (sendNotification) {
                    const msg = `Neuer Zeiteintrag von ${currentUser.name} für ${date} (${hours.toFixed(1)}h).`;
                    await sendSubmissionNotification(notificationTarget, msg);
                }

                alert(showAlert);
                closeModal('timeModal');
                e.target.reset();
            } catch (error) {
                console.error('Fehler beim Eintragen der Zeit:', error);
                alert(`Fehler: ${error.message}`);
            }
        }

        async function submitVacation(e) {
            e.preventDefault();
            const start = document.getElementById('vacationStart').value;
            const end = document.getElementById('vacationEnd').value;
            const reason = document.getElementById('vacationReason').value;
            const days = calculateWorkdays(start, end);
            if (days < 0) { alert("Das Enddatum muss nach dem Startdatum liegen."); return; }
            if (days === 0) { alert("Geht nicht wegen Sa und So. Der ausgewählte Zeitraum enthält keine Arbeitstage."); return; }

            // --- NEUER WORKFLOW ---
            let newStatus = 'pending_manager';
            let showAlert = 'Urlaubsantrag erfolgreich eingereicht! Wartet auf Genehmigung.';
            let sendNotification = true;
            let approverEmail = null;
            let approverRole = null;
            let notificationTarget = {};

            if (currentUser.role === 'ceo') {
                newStatus = 'approved';
                showAlert = 'Urlaubsantrag als CEO direkt verbucht.';
                sendNotification = false;
            } else if (currentUser.role === 'hr') {
                newStatus = 'pending_ceo';
                approverRole = 'ceo';
                notificationTarget = { role: 'ceo' };
                showAlert = 'Urlaubsantrag eingereicht. Wartet auf CEO-Genehmigung.';
            } else if (currentUser.role === 'vorgesetzter') {
                newStatus = 'pending_hr';
                approverRole = 'hr';
                notificationTarget = { role: 'hr' };
                showAlert = 'Urlaubsantrag eingereicht. Wartet auf HR-Genehmigung.';
            } else { // mitarbeiter
                if (!currentUserStats.manager_email) {
                    alert("Fehler: Ihnen ist kein Vorgesetzter zugewiesen. Bitte kontaktieren Sie HR.");
                    return;
                }
                newStatus = 'pending_manager';
                approverEmail = currentUserStats.manager_email;
                notificationTarget = { email: approverEmail };
                showAlert = 'Urlaubsantrag eingereicht. Wartet auf Genehmigung durch Vorgesetzten.';
            }
            // --- Ende Workflow ---

            const newRequest = {
                type: 'vacation',
                employeeEmail: currentUser.email,
                employeeName: currentUser.name,
                date: start,
                endDate: end,
                details: `${start} bis ${end} (${days} Arbeitstage)`,
                days: days,
                notes: reason,
                status: newStatus,
                approver_email: approverEmail,
                approver_role: approverRole
            };
            try {
                const { data, error } = await supabaseClient.from('Requests').insert(newRequest).select().single();
                if (error) throw error;
                allRequests.push(data);

                if (newStatus === 'approved') {
                    await autoApproveStats(data);
                }

                if (sendNotification) {
                    const msg = `Neuer Urlaubsantrag von ${currentUser.name} (${start} bis ${end}, ${days} Tage).`;
                    await sendSubmissionNotification(notificationTarget, msg);
                }

                alert(showAlert);
                closeModal('vacationModal');
                e.target.reset();
            } catch (error) {
                console.error('Fehler beim Senden des Urlaubs:', error);
                alert(`Fehler: ${error.message}`);
            }
        }

        async function submitSickLeave(e) {
            e.preventDefault();
            const start = document.getElementById('sickStart').value;
            const end = document.getElementById('sickEnd').value;
            const certificate = document.getElementById('sickCertificate').value;
            const notes = document.getElementById('sickNotes').value;
            const days = calculateWorkdays(start, end);
            if (days < 0) { alert("Das Enddatum muss nach dem Startdatum liegen."); return; }
            if (days === 0) { alert("Geht nicht wegen Sa und So. Der ausgewählte Zeitraum enthält keine Arbeitstage."); return; }

            // --- NEUER WORKFLOW (Krankmeldungen gehen immer an HR, außer man ist HR/CEO) ---
            let newStatus = 'pending_hr';
            let showAlert = 'Krankmeldung erfolgreich gemeldet! HR wurde informiert.';
            let sendNotification = true;
            let approverRole = 'hr';

            if (currentUser.role === 'hr' || currentUser.role === 'ceo') {
                newStatus = 'approved';
                showAlert = 'Krankmeldung als HR/CEO direkt verbucht.';
                sendNotification = false;
                approverRole = null;
            }
            // --- Ende Workflow-Logik ---

            const newRequest = {
                type: 'sick',
                employeeEmail: currentUser.email,
                employeeName: currentUser.name,
                date: start,
                endDate: end,
                details: `${start} bis ${end} (${days} Arbeitstage) - Attest: ${certificate}`,
                days: days,
                notes: notes,
                status: newStatus,
                approver_email: null,
                approver_role: approverRole
            };
            try {
                const { data, error } = await supabaseClient.from('Requests').insert(newRequest).select().single();
                if (error) throw error;
                allRequests.push(data);

                if (newStatus === 'approved') {
                    await autoApproveStats(data);
                }

                if (sendNotification) {
                    await createNotificationForRole('hr', `Neue Krankmeldung von ${currentUser.name} (${start} bis ${end}, ${days} Tage).`);
                }

                alert(showAlert);
                closeModal('sickModal');
                e.target.reset();
            } catch (error) {
                console.error('Fehler beim Senden der Krankmeldung:', error);
                alert(`Fehler: ${error.message}`);
            }
        }

        // --- Antrags-Management (Vorgesetzter/HR/CEO) ---
        function loadRequests() {
            const container = document.getElementById('requestsList');
            container.innerHTML = '';
            let relevantRequests = [];

            // --- NEUE LOGIK ZUM LADEN VON ANTRÄGEN ---
            if (currentUser.role === 'vorgesetzter') {
                relevantRequests = allRequests.filter(r =>
                    r.status === 'pending_manager' &&
                    r.approver_email === currentUser.email
                );
            } else if (currentUser.role === 'hr') {
                relevantRequests = allRequests.filter(r =>
                    (r.status === 'pending_hr' && r.approver_role === 'hr') || // Anträge von Vorgesetzten AN HR
                    r.status === 'approved_manager' // Anträge von Mitarbeitern (End-Freigabe)
                );
            } else if (currentUser.role === 'ceo') {
                relevantRequests = allRequests.filter(r =>
                    r.status === 'pending_ceo' && r.approver_role === 'ceo'
                ); // Anträge von HR
            }
            // --- Ende ---

            if (relevantRequests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">Keine ausstehenden Anträge</p>';
                return;
            }
            relevantRequests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            relevantRequests.forEach(request => {
                const card = document.createElement('div'); card.className = 'request-card';
                let typeLabel = '', statusLabel = '', statusClass = 'status-pending';
                switch (request.type) {
                    case 'time': typeLabel = '🕐 Arbeitszeiteintrag'; break;
                    case 'vacation': typeLabel = '🏖️ Urlaubsantrag'; break;
                    case 'sick': typeLabel = '🏥 Krankmeldung'; break;
                }
                switch (request.status) {
                    case 'pending_manager': statusLabel = 'Wartet auf Vorgesetzten'; statusClass = 'status-pending'; break;
                    case 'pending_hr': statusLabel = 'Wartet auf HR'; statusClass = 'status-pending'; break;
                    case 'pending_ceo': statusLabel = 'Wartet auf CEO'; statusClass = 'status-pending'; break;
                    case 'approved_manager': statusLabel = 'Vom Vorgesetzten genehmigt'; statusClass = 'status-approved'; typeLabel = '✅ ' + typeLabel; break;
                }

                card.innerHTML = `
                    <div class="request-header">
                        <div class="request-title">${typeLabel}</div>
                        <div class="request-status ${statusClass}">${statusLabel}</div>
                    </div>
                    <div class="request-details">
                        <strong>Mitarbeiter:</strong> ${request.employeeName || request.employeeEmail} (${request.employeeEmail})<br>
                        <strong>Details:</strong> ${request.details}<br>
                        ${request.notes ? `<strong>Notizen:</strong> ${request.notes}<br>` : ''}
                        <strong>Eingereicht:</strong> ${new Date(request.timestamp).toLocaleString('de-DE')}
                    </div>
                    <div class="request-actions">
                        <button class="btn-small btn-approve" onclick="processRequest(${request.id}, true)">✓ Genehmigen</button>
                        <button class="btn-small btn-reject" onclick="processRequest(${request.id}, false)">✗ Ablehnen</button>
                    </div>`;
                container.appendChild(card);
            });
        }

        // --- KORRIGIERT: processRequest MIT NEUEM WORKFLOW ---
        async function processRequest(id, approve) {
            const requestIndex = allRequests.findIndex(r => r.id === id);
            if (requestIndex === -1) return;
            const request = allRequests[requestIndex];

            let { data: userData, error: userError } = await supabaseClient
                .from('Users')
                .select('*')
                .eq('email', request.employeeEmail)
                .single();
            if (userError) { alert("Fehler: Mitarbeiter-Daten nicht gefunden."); return; }

            let msg = '';
            let newStatus = request.status;
            let newStats = {};

            try {
                if (approve) {
                    // --- Vorgesetzter genehmigt ---
                    if (currentUser.role === 'vorgesetzter' && request.status === 'pending_manager') {
                        newStatus = 'approved_manager';
                        msg = `Ihr Antrag (${request.date}) wurde vom Vorgesetzten genehmigt und an HR weitergeleitet.`;
                        await createNotificationForRole('hr', `Genehmigter Antrag von ${request.employeeName} (${request.date}) wartet auf Verbuchung.`);
                    }
                    // --- HR genehmigt ---
                    else if (currentUser.role === 'hr') {
                        // End-Genehmigung (von Mitarbeiter via Vorgesetztem)
                        if (request.status === 'approved_manager') {
                            newStatus = 'approved';
                            if (request.type === 'time') {
                                newStats = { totalHours: userData.totalHours + request.hours, overtime: userData.overtime + (request.hours - (userData.plannedHours / 260)) };
                            } else if (request.type === 'vacation') {
                                newStats = { vacationTaken: userData.vacationTaken + request.days };
                            }
                            msg = `Ihr Antrag (${request.date}) wurde von HR final genehmigt und verbucht.`;
                        }
                        // Genehmigung von Antrag eines Vorgesetzten oder Krankmeldung
                        else if (request.status === 'pending_hr') {
                            newStatus = 'approved';
                            if (request.type === 'time') {
                                newStats = { totalHours: userData.totalHours + request.hours, overtime: userData.overtime + (request.hours - (userData.plannedHours / 260)) };
                            } else if (request.type === 'vacation') {
                                newStats = { vacationTaken: userData.vacationTaken + request.days };
                            } else if (request.type === 'sick') {
                                newStats = { sickDays: userData.sickDays + request.days };
                            }
                            msg = `Ihr Antrag (${request.date}) wurde von HR genehmigt und verbucht.`;
                        }
                    }
                    // --- CEO genehmigt ---
                    else if (currentUser.role === 'ceo' && request.status === 'pending_ceo') {
                        newStatus = 'approved';
                        if (request.type === 'time') {
                            newStats = { totalHours: userData.totalHours + request.hours, overtime: userData.overtime + (request.hours - (userData.plannedHours / 260)) };
                        } else if (request.type === 'vacation') {
                            newStats = { vacationTaken: userData.vacationTaken + request.days };
                        }
                        msg = `Ihr Antrag (${request.date}) wurde vom CEO genehmigt und verbucht.`;
                    }
                } else {
                    // --- Ablehnung (gilt für alle Rollen) ---
                    const reason = prompt('Grund für die Ablehnung (optional):');
                    newStatus = 'rejected';
                    let typeText = request.type === 'time' ? 'Zeiteintrag' : (request.type === 'vacation' ? 'Urlaubsantrag' : 'Krankmeldung');
                    msg = `Ihr ${typeText} (${request.date}) wurde abgelehnt. Grund: ${reason || 'Kein Grund angegeben'}`;
                }

                // 1. Request-Status in DB ändern
                const { data: updatedRequest, error: reqUpdateError } = await supabaseClient
                    .from('Requests')
                    .update({ status: newStatus })
                    .eq('id', request.id)
                    .select()
                    .single();
                if (reqUpdateError) throw reqUpdateError;

                // 2. Ggf. User-Stats in DB ändern
                if (Object.keys(newStats).length > 0) {
                    const { data: updatedUser, error: userUpdateError } = await supabaseClient
                        .from('Users')
                        .update(newStats)
                        .eq('email', request.employeeEmail)
                        .select()
                        .single();
                    if (userUpdateError) throw userUpdateError;

                    const userIndex = allUsers.findIndex(u => u.email === updatedUser.email);
                    if (userIndex !== -1) {
                        allUsers[userIndex] = updatedUser;
                    }

                    if (currentUser.email === updatedUser.email) {
                        currentUserStats = updatedUser;
                        updateDashboardStats();
                    }
                }

                // 3. Benachrichtigung an den ursprünglichen Antragsteller senden
                if (msg) {
                    await createNotification(request.employeeEmail, msg);
                }

                allRequests[requestIndex] = updatedRequest;
                alert(approve ? 'Genehmigt!' : 'Abgelehnt!');
                loadRequests();
            } catch (error) {
                console.error('Fehler beim Verarbeiten:', error);
                alert(`Fehler: ${error.message}`);
            }
        }

        // --- Benachrichtigungs-System ---
        async function createNotification(userEmail, message) {
            const newNotification = {
                targetEmail: userEmail,
                targetRole: null,
                message: message
            };
            try {
                const { data, error } = await supabaseClient.from('Notifications').insert(newNotification).select().single();
                if (error) throw error;
                allNotifications.push(data);
            } catch (error) {
                console.error('Fehler beim Erstellen der Notification:', error);
            }
        }

        async function createNotificationForRole(role, message) {
            const newNotification = {
                targetEmail: null,
                targetRole: role,
                message: message
            };
            try {
                const { data, error } = await supabaseClient.from('Notifications').insert(newNotification).select().single();
                if (error) throw error;
                allNotifications.push(data);
                updateNotificationButton();
            } catch (error) {
                console.error('Fehler beim Erstellen der Rollen-Notification:', error);
            }
        }

        function updateNotificationButton() {
            if (!currentUser) return;
            const unreadCount = allNotifications.filter(n =>
                !n.read &&
                (n.targetEmail === currentUser.email || n.targetRole === currentUser.role)
            ).length;
            const countBubble = document.getElementById('notificationCount');
            countBubble.textContent = unreadCount;
            countBubble.classList.toggle('visible', unreadCount > 0);
        }

        async function loadNotifications() {
            const container = document.getElementById('notificationList');
            container.innerHTML = '';
            const userNotifications = allNotifications
                .filter(n => n.targetEmail === currentUser.email || n.targetRole === currentUser.role)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (userNotifications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;">Keine Meldungen vorhanden.</p>';
                return;
            }
            const unreadIds = [];
            userNotifications.forEach(n => {
                const card = document.createElement('div');
                card.className = n.read ? 'notification-card' : 'notification-card unread';
                card.innerHTML = `
                    <div class="notification-timestamp">${new Date(n.timestamp).toLocaleString('de-DE')}</div>
                    <div class="notification-message">${n.message}</div>
                `;
                container.appendChild(card);
                if (!n.read) {
                    n.read = true;
                    unreadIds.push(n.id);
                }
            });
            updateNotificationButton();
            if (unreadIds.length > 0) {
                const { error } = await supabaseClient
                    .from('Notifications')
                    .update({ read: true })
                    .in('id', unreadIds);
                if (error) console.error("Fehler beim 'als gelesen' markieren:", error);
            }
        }

        // --- Detail-Kalender ---
        function generateDetailCalendar() {
            const container = document.getElementById('detailCalendarContainer');
            container.innerHTML = '';
            document.getElementById('detailCalendarTitle').textContent = `Jahresübersicht ${currentYear}`;
            const calendarWrapper = document.createElement('div');
            calendarWrapper.className = 'detail-calendar';
            const dayData = new Map();
            const userRequests = allRequests.filter(r =>
                r.employeeEmail === currentUser.email &&
                r.status === 'approved' &&
                (parseLocalDate(r.date).getFullYear() === currentYear || (r.endDate && parseLocalDate(r.endDate).getFullYear() === currentYear))
            );
            userRequests.filter(r => r.type === 'time').forEach(req => dayData.set(req.date, 'work'));
            userRequests.filter(r => (r.type === 'vacation' || r.type === 'sick') && r.endDate).forEach(req => {
                for (let d = parseLocalDate(req.date); d <= parseLocalDate(req.endDate); d.setDate(d.getDate() + 1)) {
                    const isoDate = toLocalISOString(d);
                    dayData.set(isoDate, req.type);
                }
            });
            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div'); monthDiv.className = 'detail-month';
                const daysGrid = document.createElement('div'); daysGrid.className = 'detail-days-grid';
                const weekdays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
                weekdays.forEach(day => {
                    const headerCell = document.createElement('div'); headerCell.className = 'detail-day-header';
                    headerCell.textContent = day; daysGrid.appendChild(headerCell);
                });
                const firstDayOfMonth = new Date(currentYear, month, 1);
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                let startingDayOfWeek = firstDayOfMonth.getDay();
                if (startingDayOfWeek === 0) startingDayOfWeek = 6; else startingDayOfWeek -= 1;
                for (let i = 0; i < startingDayOfWeek; i++) {
                    const emptyCell = document.createElement('div'); emptyCell.className = 'detail-day empty';
                    daysGrid.appendChild(emptyCell);
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    const currentDate = new Date(currentYear, month, day);
                    const isoDate = toLocalISOString(currentDate);
                    const dayOfWeek = currentDate.getDay();
                    dayCell.className = 'detail-day'; dayCell.textContent = day;
                    const status = dayData.get(isoDate);
                    if (status) { dayCell.classList.add(status); }
                    else if (dayOfWeek === 0 || dayOfWeek === 6) { dayCell.classList.add('weekend'); }
                    daysGrid.appendChild(dayCell);
                }
                monthDiv.innerHTML = `<h4 class="detail-month-title">${monthNames[month]}</h4>`;
                monthDiv.appendChild(daysGrid);
                calendarWrapper.appendChild(monthDiv);
            }
            container.appendChild(calendarWrapper);
        }

        // --- HR Mitarbeiterverwaltung ---
        function loadUserManagementList() {
            const container = document.getElementById('userManagementList');
            container.innerHTML = '';

            if (!allUsers || allUsers.length === 0) {
                container.innerHTML = '<p>Keine Mitarbeiterdaten geladen.</p>';
                return;
            }

            let tableHTML = `
                <table class="user-manage-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Rolle</th>
                            <th>Abteilung</th>
                            <th>Manager</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allUsers.forEach(user => {
                const manager = allUsers.find(m => m.email === user.manager_email);
                const managerName = manager ? manager.name : '---';

                tableHTML += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>${user.abteilung || '---'}</td>
                        <td>${managerName}</td>
                        <td class="action-cell">
                            <button class="btn-small" onclick="openEditUserModal('${user.email}')">Bearbeiten</button>
                            <button class="btn-small btn-reject" onclick="deleteUser('${user.email}', '${user.name}')">Löschen</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        // NEU: Öffnet das "Mitarbeiter hinzufügen"-Modal
        function openAddUserModal() {
            document.getElementById('addUserForm').reset();
            // Füllt das Manager-Dropdown (standardmäßig für "mitarbeiter")
            toggleManagerSelect('mitarbeiter', 'addUserManager', 'addUserManagerGroup');
            closeModal('userManagementModal');
            openModal('addUserModal');
        }

        function openEditUserModal(email) {
            const user = allUsers.find(u => u.email === email);
            if (!user) {
                alert('Fehler: User nicht im Cache gefunden.');
                return;
            }

            document.getElementById('editUserTitle').textContent = `Bearbeite: ${user.name}`;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editTotalHours').value = user.totalHours;
            document.getElementById('editVacationTotal').value = user.vacationTotal;
            document.getElementById('editVacationTaken').value = user.vacationTaken;
            document.getElementById('editSickDays').value = user.sickDays;
            document.getElementById('editOvertime').value = user.overtime;
            document.getElementById('editWeeklyHours').value = (user.plannedHours / 52);
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserAbteilung').value = user.abteilung || '';

            // 1. ZUERST die Dropdown-Optionen basierend auf der Rolle füllen
            toggleManagerSelect(user.role, 'editUserManager', 'managerSelectGroup');

            // 2. DANN den aktuell gespeicherten Wert auswählen
            document.getElementById('editUserManager').value = user.manager_email || "";

            loadUserRequestHistory(email);
            openModal('editUserModal');
        }

        // KORRIGIERT: Füllt das Manager-Dropdown dynamisch je nach ROLLE
        function toggleManagerSelect(selectedRole, selectElementId = 'editUserManager', groupElementId = 'managerSelectGroup') {
            const managerGroup = document.getElementById(groupElementId);
            const managerSelect = document.getElementById(selectElementId);

            managerSelect.innerHTML = '<option value="">-- Keiner zugewiesen --</option>'; // Reset
            let managers = [];

            if (selectedRole === 'mitarbeiter') {
                managerGroup.style.display = 'block';
                managers = allUsers.filter(u => u.role === 'vorgesetzter');
            } else if (selectedRole === 'vorgesetzter' || selectedRole === 'hr') {
                managerGroup.style.display = 'block';
                managers = allUsers.filter(u => u.role === 'ceo');
            } else {
                managerGroup.style.display = 'none'; // CEOs haben keinen Manager
            }

            managers.forEach(manager => {
                // Verhindern, dass sich ein User selbst als Manager zuweist (wichtig für AddUser-Modal)
                const potentialUserEmail = (selectElementId === 'editUserManager')
                    ? document.getElementById('editUserEmail').value
                    : document.getElementById('addUserEmail').value;

                if (manager.email !== potentialUserEmail) {
                    const option = document.createElement('option');
                    option.value = manager.email;
                    option.textContent = `${manager.name} (${manager.email})`;
                    managerSelect.appendChild(option);
                }
            });
        }

        async function submitUserEdit(event) {
            event.preventDefault();
            const btn = event.target.querySelector('.btn');
            btn.textContent = 'Speichere...';
            btn.disabled = true;

            const userEmail = document.getElementById('editUserEmail').value;
            const weeklyHours = parseFloat(document.getElementById('editWeeklyHours').value);
            const selectedRole = document.getElementById('editUserRole').value;

            const updatedData = {
                role: selectedRole,
                abteilung: document.getElementById('editUserAbteilung').value || null,
                manager_email: (selectedRole !== 'ceo') ? (document.getElementById('editUserManager').value || null) : null,
                totalHours: parseFloat(document.getElementById('editTotalHours').value),
                vacationTotal: parseInt(document.getElementById('editVacationTotal').value),
                vacationTaken: parseInt(document.getElementById('editVacationTaken').value),
                sickDays: parseInt(document.getElementById('editSickDays').value),
                overtime: parseFloat(document.getElementById('editOvertime').value),
                plannedHours: weeklyHours * 52
            };

            try {
                const { data: updatedUser, error } = await supabaseClient
                    .from('Users')
                    .update(updatedData)
                    .eq('email', userEmail)
                    .select()
                    .single();

                if (error) throw error;

                const userIndex = allUsers.findIndex(u => u.email === userEmail);
                if (userIndex !== -1) {
                    allUsers[userIndex] = updatedUser;
                }

                if (currentUser && currentUser.email === userEmail) {
                    currentUserStats = updatedUser;
                    updateDashboardStats();
                }

                alert('Benutzerdaten erfolgreich gespeichert!');
                closeModal('editUserModal');
                loadUserManagementList();

            } catch (error) {
                console.error('Fehler beim Speichern der Benutzerdaten:', error);
                alert(`Speichern fehlgeschlagen: ${error.message}`);
            } finally {
                btn.textContent = 'Änderungen speichern';
                btn.disabled = false;
            }
        }

        // NEU: Funktion zum Hinzufügen von Benutzern
        async function submitAddUser(event) {
            event.preventDefault();
            const btn = event.target.querySelector('.btn');
            btn.textContent = 'Erstelle...';
            btn.disabled = true;

            const name = document.getElementById('addUserName').value;
            const email = document.getElementById('addUserEmail').value.toLowerCase();
            const password = document.getElementById('addUserPassword').value;
            const role = document.getElementById('addUserRole').value;
            const abteilung = document.getElementById('addUserAbteilung').value || null;
            const weeklyHours = parseFloat(document.getElementById('addWeeklyHours').value);
            const vacationTotal = parseInt(document.getElementById('addVacationTotal').value);
            const manager_email = (role !== 'ceo') ? (document.getElementById('addUserManager').value || null) : null;

            try {
                // 1. Benutzer im sicheren Auth-System erstellen
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (authError) throw authError;

                // 2. Benutzer-Profil in der 'Users'-Tabelle erstellen
                const profileData = {
                    email: email,
                    name: name,
                    role: role,
                    abteilung: abteilung,
                    manager_email: manager_email,
                    plannedHours: weeklyHours * 52,
                    vacationTotal: vacationTotal
                };

                const { data: newProfile, error: profileError } = await supabaseClient
                    .from('Users')
                    .insert(profileData)
                    .select()
                    .single();

                if (profileError) throw profileError;

                // --- KORRIGIERT: NEUE BENACHRICHTIGUNGS-LOGIK ---
                // 3. Benachrichtigung an den Manager (Chef oder CEO)
                if (manager_email) {
                    const message = `Ein neuer Mitarbeiter wurde Ihnen zugewiesen: ${name} (${email}). Das initiale Passwort lautet: ${password}`;
                    await createNotification(manager_email, message);
                }

                // 4. Benachrichtigung an den neuen Mitarbeiter selbst
                const welcomeMessage = `Willkommen, ${name}! Ihr Konto wurde erstellt. Bitte bestätigen Sie Ihre E-Mail. Ihr Manager wurde über Ihr initiales Passwort informiert.`;
                await createNotification(email, welcomeMessage);
                // --- Ende ---

                allUsers.push(newProfile);

                alert(`Benutzer ${name} erfolgreich erstellt! Eine Bestätigungs-E-Mail wurde an ${email} gesendet UND der zuständige Manager wurde benachrichtigt.`);
                closeModal('addUserModal');
                openModal('userManagementModal'); // Zurück zur Liste

            } catch (error) {
                console.error("Fehler beim Erstellen des Benutzers:", error.message);
                alert(`Fehler: ${error.message}`);
            } finally {
                btn.textContent = 'Mitarbeiter erstellen';
                btn.disabled = false;
            }
        }

        // NEU: Funktion zum Löschen von Benutzern
        async function deleteUser(email, name) {
            if (!confirm(`Wollen Sie ${name} (${email}) wirklich löschen? \nWARNUNG: Alle Anträge und Meldungen dieser Person werden ebenfalls gelöscht. Dies kann nicht rückgängig gemacht werden.`)) {
                return;
            }
            console.log(`Lösche User: ${email}`);
            try {
                // 1. Alle Anträge löschen
                const { error: reqError } = await supabaseClient.from('Requests').delete().eq('employeeEmail', email);
                if (reqError) throw reqError;

                // 2. Alle Meldungen löschen
                const { error: notifError } = await supabaseClient.from('Notifications').delete().eq('targetEmail', email);
                if (notifError) throw notifError;

                // 3. Profil aus 'Users' löschen
                const { error: userError } = await supabaseClient.from('Users').delete().eq('email', email);
                if (userError) throw userError;

                // 4. Lokalen Cache aktualisieren
                allUsers = allUsers.filter(u => u.email !== email);
                allRequests = allRequests.filter(r => r.employeeEmail !== email);
                allNotifications = allNotifications.filter(n => n.targetEmail !== email);

                alert(`Benutzerprofil für ${name} erfolgreich gelöscht.\n\nWICHTIG: Sie müssen den Login-Zugang (Auth) dieses Benutzers jetzt manuell in Ihrem Supabase-Dashboard im "Authentication"-Tab löschen, um den Login zu sperren.`);
                loadUserManagementList(); // Liste neu laden

            } catch (error) {
                console.error('Fehler beim Löschen des Users:', error);
                alert(`Fehler: ${error.message}`);
            }
        }

        // --- HR Stornieren-Funktionen ---
        function loadUserRequestHistory(email) {
            const container = document.getElementById('editUserRequestsList');
            container.innerHTML = '';

            const userRequests = allRequests.filter(r =>
                r.employeeEmail === email &&
                r.status === 'approved'
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (userRequests.length === 0) {
                container.innerHTML = '<p>Dieser Mitarbeiter hat keine genehmigten Anträge.</p>';
                return;
            }

            let tableHTML = `
                <table class="request-history-table">
                    <thead>
                        <tr>
                            <th>Typ</th>
                            <th>Datum</th>
                            <th>Details</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            userRequests.forEach(req => {
                let typeLabel = req.type === 'time' ? 'Zeit' : (req.type === 'vacation' ? 'Urlaub' : 'Krank');
                tableHTML += `
                    <tr>
                        <td>${typeLabel}</td>
                        <td>${req.date}</td>
                        <td>${req.details}</td>
                        <td>
                            <button class="btn-small btn-reject" onclick="stornierenRequest(${req.id})">
                                Stornieren
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        async function stornierenRequest(requestId) {
            if (!confirm('Diesen Antrag wirklich stornieren? Dies kann nicht rückgängig gemacht werden und korrigiert die Statistik des Mitarbeiters.')) {
                return;
            }

            const requestIndex = allRequests.findIndex(r => r.id === requestId);
            if (requestIndex === -1) {
                alert('Fehler: Antrag nicht im Cache gefunden.');
                return;
            }
            const request = allRequests[requestIndex];

            let userStats = allUsers.find(u => u.email === request.employeeEmail);
            if (!userStats) {
                let { data: userStatsFromDB, error: userError } = await supabaseClient
                    .from('Users')
                    .select('*')
                    .eq('email', request.employeeEmail)
                    .single();
                if (userError) {
                    alert('Fehler: Mitarbeiter-Profil nicht gefunden.');
                    return;
                }
                userStats = userStatsFromDB;
            }

            let statsToUpdate = {
                totalHours: userStats.totalHours,
                overtime: userStats.overtime,
                vacationTaken: userStats.vacationTaken,
                sickDays: userStats.sickDays
            };

            if (request.type === 'time') {
                statsToUpdate.totalHours -= request.hours;
                statsToUpdate.overtime -= (request.hours - (userStats.plannedHours / 260));
            } else if (request.type === 'vacation') {
                statsToUpdate.vacationTaken -= request.days;
            } else if (request.type === 'sick') {
                statsToUpdate.sickDays -= request.days;
            }

            try {
                const { data: updatedUser, error: userUpdateError } = await supabaseClient
                    .from('Users')
                    .update(statsToUpdate)
                    .eq('email', userStats.email)
                    .select()
                    .single();

                if (userUpdateError) throw userUpdateError;

                const { data: updatedRequest, error: reqUpdateError } = await supabaseClient
                    .from('Requests')
                    .update({ status: 'storniert' })
                    .eq('id', request.id)
                    .select()
                    .single();

                if (reqUpdateError) throw reqUpdateError;

                const userCacheIndex = allUsers.findIndex(u => u.email === updatedUser.email);
                if (userCacheIndex > -1) allUsers[userCacheIndex] = updatedUser;
                allRequests[requestIndex] = updatedRequest;

                if (currentUser && currentUser.email === updatedUser.email) {
                    currentUserStats = updatedUser;
                    updateDashboardStats();
                }

                alert('Antrag erfolgreich storniert!');

                loadUserRequestHistory(userStats.email);
                loadUserManagementList();
                generateCalendar();

            } catch (error) {
                console.error('Fehler beim Stornieren:', error);
                alert(`Fehler: ${error.message}`);
            }
        }

        async function submitForgotPassword(e) {
            e.preventDefault();
            const btn = e.target.querySelector('.btn');
            btn.textContent = 'Sende...';
            btn.disabled = true;
            const email = document.getElementById('forgotEmail').value.toLowerCase();

            try {
                // HINWEIS: Dies sendet eine E-Mail an den Benutzer.
                // Sie müssen E-Mail-Vorlagen in Ihrem Supabase-Projekt aktivieren!
                const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin // Link, zu dem der User nach Klick in der E-Mail zurückkehrt
                });

                if (error) throw error;

                alert('Anweisungen zum Zurücksetzen des Passworts wurden an Ihre E-Mail gesendet.');
                closeModal('forgotPasswordModal');
                e.target.reset();
            } catch (error) {
                console.error('Fehler bei Passwort-Reset:', error);
                alert(`Fehler: ${error.message}. Ist die E-Mail korrekt?`);
            } finally {
                btn.textContent = 'Link anfordern';
                btn.disabled = false;
            }
        }

        async function submitChangePassword(e) {
            e.preventDefault();
            const btn = e.target.querySelector('.btn');
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword.length < 6) {
                alert('Das Passwort muss mindestens 6 Zeichen lang sein.');
                return;
            }
            if (newPassword !== confirmPassword) {
                alert('Die Passwörter stimmen nicht überein.');
                return;
            }

            btn.textContent = 'Ändere...';
            btn.disabled = true;

            try {
                // Diese Funktion ändert das Passwort des aktuell eingeloggten Benutzers
                const { data, error } = await supabaseClient.auth.updateUser({ password: newPassword });
                if (error) throw error;

                alert('Passwort erfolgreich geändert!');
                closeModal('changePasswordModal');
                e.target.reset();
            } catch (error) {
                console.error('Fehler beim Ändern des Passworts:', error);
                alert(`Fehler: ${error.message}`);
            } finally {
                btn.textContent = 'Passwort ändern';
                btn.disabled = false;
            }
        }


        // --- INIT & HELPER ---
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });

        window.onload = function () {
            const today = getLocalISODate();

            // KORRIGIERT: Fehlende Zeilen wiederhergestellt
            document.getElementById('timeDate').value = today;
            document.getElementById('vacationStart').value = today;
            document.getElementById('vacationEnd').value = today;
            document.getElementById('sickStart').value = today;
            document.getElementById('sickEnd').value = today;

            // NEU: Event-Listener für "Passwort vergessen"
            document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
                e.preventDefault();
                openModal('forgotPasswordModal');
            });

            checkSessionAndLoad();
        };

        async function checkSessionAndLoad() {
            console.log("Prüfe auf aktive Sitzung...");

            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

            if (sessionError) {
                console.error("Fehler beim Abrufen der Sitzung:", sessionError);
                return;
            }

            if (session) {
                console.log("Aktive Sitzung gefunden für:", session.user.email);

                let { data: userStats, error: userError } = await supabaseClient
                    .from('Users')
                    .select('*')
                    .eq('email', session.user.email)
                    .single();

                if (userError || !userStats) {
                    console.error("Sitzung gefunden, aber User-Profil nicht in 'Users'-Tabelle.", userError);
                    await supabaseClient.auth.signOut();
                    return;
                }

                currentUser = { email: userStats.email, role: userStats.role, name: userStats.name };
                currentUserStats = userStats;

                await loadAllDataFromSupabase();

                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userRole').textContent = getRoleDisplay(userStats.role);

                updateDashboardStats();
                generateCalendar();

                const manageUsersBtn = document.getElementById('manageUsersBtn');
                const requestsSection = document.getElementById('requestsSection');

                if (userStats.role === 'hr') {
                    requestsSection.style.display = 'block';
                    document.getElementById('dashboardTitle').textContent = 'Management Dashboard';
                    manageUsersBtn.style.display = 'inline-block';
                    loadRequests();
                } else if (userStats.role === 'vorgesetzter' || userStats.role === 'ceo') {
                    requestsSection.style.display = 'block';
                    document.getElementById('dashboardTitle').textContent = 'Management Dashboard';
                    manageUsersBtn.style.display = 'none';
                    loadRequests();
                } else {
                    requestsSection.style.display = 'none';
                    document.getElementById('dashboardTitle').textContent = 'Mein Dashboard';
                    manageUsersBtn.style.display = 'none';
                }

                document.getElementById('notificationBtn').style.display = 'inline-block';
                updateNotificationButton();

            } else {
                console.log("Keine aktive Sitzung gefunden. Zeige Login-Bildschirm.");
            }
        }
    </script>
</body>

</html>